import { useState, useEffect } from 'react';
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { Button } from "@/components/ui/button";
import { Progress } from "@/components/ui/progress";
import { Lock, CheckCircle, Play, BookOpen } from "lucide-react";
import { useQuery, useMutation, useQueryClient } from "@tanstack/react-query";
import { apiRequest } from "@/lib/queryClient";
import { useToast } from "@/hooks/use-toast";

interface ChapterProgressProps {
  userId: string;
  userGeneration?: string;
  userArchetype?: string;
}

const booksData = [
  {
    number: 1,
    name: "Yod - Becoming Rooted",
    hebrewLetter: "י",
    theme: "Identity, Calling, and the Formation of Glory",
    element: "Fire",
    color: "red",
    chapters: [1, 2, 3, 4, 5],
    description: "Foundation of leadership identity and calling"
  },
  {
    number: 2,
    name: "Heh - Becoming Aligned",
    hebrewLetter: "ה",
    theme: "Patterns and the Spiritual Core of Leadership",
    element: "Air",
    color: "blue",
    chapters: [6, 7, 8, 9, 10],
    description: "Alignment with divine patterns and wisdom"
  },
  {
    number: 3,
    name: "Vav - Becoming Clear",
    hebrewLetter: "ו",
    theme: "Vision, Emotional Intelligence, and the Inner Compass",
    element: "Water",
    color: "teal",
    chapters: [11, 12, 13, 14, 15],
    description: "Clarity of vision and emotional intelligence"
  },
  {
    number: 4,
    name: "Final Heh - Becoming Embodied",
    hebrewLetter: "ה",
    theme: "Walking in Wisdom, Spirit, and Glory",
    element: "Earth",
    color: "green",
    chapters: [16, 17, 18, 19, 20],
    description: "Embodied leadership and practical wisdom"
  },
  {
    number: 5,
    name: "YESHUA - The Pattern Manifesto",
    hebrewLetter: "ש",
    theme: "Jesus, the Fractal Fulfillment, and the Apostolic Flame",
    element: "Plasma",
    color: "yellow",
    chapters: [21, 22, 23, 24, 25, 26, 27],
    description: "Christ as the ultimate leadership pattern"
  }
];

const chapterTitles: Record<number, string> = {
  1: "Leadership Begins at the Altar",
  2: "The Tripartite Leader: Spirit, Soul, and Body",
  3: "Why We Had to Leave Eden",
  4: "Formation in Exile: The Purpose of the Fall",
  5: "The Seed Hidden in the Dust",
  6: "Jesus as the Tree of Life, the Flaming Sword, and the Cosmic Unifier",
  7: "The Divine Pattern: YHWH Structure and the Wings of Wisdom",
  8: "The Pattern Keeper: Heaven's Interface and Leadership Design",
  9: "The Fractal Pattern of Leadership",
  10: "The Invisible Root System of Authority",
  11: "Vision of God: The First Call of Every Leader",
  12: "Vision of Self: Emotional Tools and Soul Awareness",
  13: "Vision of Mission: Discovering Your Divine Measure",
  14: "The Wounded Visionary: Leading Through Inner Conflict",
  15: "Sacred Sight: From Revelation to Discernment",
  16: "Emotional Intelligence and Passion",
  17: "Intelligent Action: Decision-Making in Alignment with the Spirit",
  18: "Embodied Leadership: Why Your Body Matters",
  19: "Mentors and Mirrors: Leading Like Jesus in a Fractured World",
  20: "The Body of Christ: Flesh Made Flame",
  21: "Yeshua: The Embodiment of YHWH",
  22: "The Spiral and the Sword: Jesus as Pattern and Portal",
  23: "The Name and the Nations: Fractal Mission in the Latter Days",
  24: "Pentecost, Fire, and the Echo of Eden",
  25: "The Commissioning Pattern: Jesus and the Sending of the Flame",
  26: "The Apostolic Flame: Paul and the Global Replication Pattern",
  27: "The Pattern Complete: Living as YESHUA"
};

export default function ChapterProgress({ userId, userGeneration, userArchetype }: ChapterProgressProps) {
  const { toast } = useToast();
  const queryClient = useQueryClient();

  const { data: progressData, isLoading } = useQuery({
    queryKey: ['/api/user', userId, 'progress'],
    queryFn: async () => {
      const response = await apiRequest("GET", `/api/user/${userId}/progress`);
      return response.json();
    },
    enabled: !!userId,
  });

  const { data: availableChapters } = useQuery({
    queryKey: ['/api/chapters/available', userId],
    queryFn: async () => {
      const response = await apiRequest("GET", `/api/chapters/available/${userId}`);
      return response.json();
    },
    enabled: !!userId,
  });

  const unlockChapterMutation = useMutation({
    mutationFn: async (chapterNumber: number) => {
      const response = await apiRequest("POST", `/api/chapters/${chapterNumber}/unlock`);
      return response.json();
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['/api/chapters/available', userId] });
      queryClient.invalidateQueries({ queryKey: ['/api/user', userId, 'progress'] });
    },
  });

  const completeChapterMutation = useMutation({
    mutationFn: async ({ chapterNumber, score }: { chapterNumber: number; score: number }) => {
      const response = await apiRequest("POST", `/api/chapters/${chapterNumber}/complete`, {
        assessmentScore: score,
        practiceMinutes: 0
      });
      return response.json();
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['/api/chapters/available', userId] });
      queryClient.invalidateQueries({ queryKey: ['/api/user', userId, 'progress'] });
      toast({
        title: "Chapter Completed!",
        description: "You've unlocked the next chapter in your journey.",
      });
    },
  });

  const getBookColor = (color: string) => {
    switch (color) {
      case 'red': return 'bg-red-500/20 border-red-500/40 text-red-300';
      case 'blue': return 'bg-blue-500/20 border-blue-500/40 text-blue-300';
      case 'teal': return 'bg-teal-500/20 border-teal-500/40 text-teal-300';
      case 'green': return 'bg-green-500/20 border-green-500/40 text-green-300';
      case 'yellow': return 'bg-yellow-500/20 border-yellow-500/40 text-yellow-300';
      default: return 'bg-gray-500/20 border-gray-500/40 text-gray-300';
    }
  };

  const getChapterStatus = (chapterNumber: number) => {
    if (!availableChapters) return 'locked';
    
    const completed = progressData?.chapters?.filter((c: any) => c.completed).map((c: any) => c.chapterNumber) || [];
    
    if (completed.includes(chapterNumber)) return 'completed';
    if (availableChapters.available.includes(chapterNumber)) return 'available';
    if (availableChapters.preview.includes(chapterNumber)) return 'preview';
    return 'locked';
  };

  const handleChapterAction = (chapterNumber: number, status: string) => {
    if (status === 'available') {
      unlockChapterMutation.mutate(chapterNumber);
    } else if (status === 'completed') {
      // Navigate to chapter content
      window.location.href = `/matrix?chapter=${chapterNumber}&archetype=${userArchetype}&generation=${userGeneration}`;
    }
  };

  const renderChapter = (chapterNumber: number, bookColor: string) => {
    const status = getChapterStatus(chapterNumber);
    const title = chapterTitles[chapterNumber] || `Chapter ${chapterNumber}`;
    
    return (
      <Card 
        key={chapterNumber}
        className={`cursor-pointer transition-all duration-200 ${
          status === 'locked' ? 'opacity-50 cursor-not-allowed' : 'hover:shadow-md'
        }`}
        onClick={() => status !== 'locked' && handleChapterAction(chapterNumber, status)}
      >
        <CardContent className="p-4">
          <div className="flex items-center justify-between">
            <div className="flex-1">
              <div className="flex items-center gap-2 mb-2">
                <Badge variant="outline" className="text-xs">
                  Chapter {chapterNumber}
                </Badge>
                {status === 'completed' && <CheckCircle className="w-4 h-4 text-green-500" />}
                {status === 'available' && <Play className="w-4 h-4 text-blue-500" />}
                {status === 'preview' && <BookOpen className="w-4 h-4 text-yellow-500" />}
                {status === 'locked' && <Lock className="w-4 h-4 text-gray-500" />}
              </div>
              
              <h4 className={`font-medium text-sm ${status === 'locked' ? 'text-gray-500' : ''}`}>
                {status === 'locked' ? '••••••••••••••••••••' : title}
              </h4>
              
              {status !== 'locked' && (
                <p className="text-xs text-muted-foreground mt-1">
                  {status === 'completed' && 'Review chapter content'}
                  {status === 'available' && 'Click to begin this chapter'}
                  {status === 'preview' && 'Coming soon - complete previous chapters'}
                </p>
              )}
            </div>
          </div>
        </CardContent>
      </Card>
    );
  };

  if (isLoading) {
    return (
      <div className="space-y-6">
        <div className="animate-pulse">
          <div className="h-8 bg-gray-300 rounded w-1/3 mb-4"></div>
          <div className="space-y-3">
            {[1, 2, 3].map(i => (
              <div key={i} className="h-20 bg-gray-300 rounded"></div>
            ))}
          </div>
        </div>
      </div>
    );
  }

  const bookProgress = progressData?.books || {};
  const totalChapters = 27;
  const completedChapters = progressData?.chapters?.filter((c: any) => c.completed).length || 0;
  const overallProgress = Math.round((completedChapters / totalChapters) * 100);

  return (
    <div className="space-y-6">
      {/* Overall Progress */}
      <Card>
        <CardHeader>
          <CardTitle className="flex items-center justify-between">
            <span>Your Fractal Leadership Journey</span>
            <Badge className="bg-cosmic-golden/20 text-cosmic-golden">
              {completedChapters} / {totalChapters} Chapters
            </Badge>
          </CardTitle>
        </CardHeader>
        <CardContent>
          <div className="space-y-4">
            <div>
              <div className="flex justify-between text-sm mb-2">
                <span>Overall Progress</span>
                <span>{overallProgress}%</span>
              </div>
              <Progress value={overallProgress} className="h-3" />
            </div>
            
            {userGeneration && userArchetype && (
              <div className="flex gap-2">
                <Badge variant="outline">
                  {userGeneration.replace('-', ' ').toUpperCase()} Generation
                </Badge>
                <Badge variant="outline">
                  {userArchetype.charAt(0).toUpperCase() + userArchetype.slice(1)} Leader
                </Badge>
              </div>
            )}
          </div>
        </CardContent>
      </Card>

      {/* Books Progress */}
      <div className="space-y-6">
        {booksData.map(book => {
          const progress = bookProgress[`book${book.number}`] || { completed: 0, total: book.chapters.length, unlocked: false };
          const isUnlocked = progress.unlocked || book.number === 1;
          
          return (
            <Card key={book.number} className={`border-2 ${getBookColor(book.color)}`}>
              <CardHeader>
                <CardTitle className="flex items-center justify-between">
                  <div className="flex items-center gap-3">
                    <div className="text-2xl font-bold">{book.hebrewLetter}</div>
                    <div>
                      <h3 className="text-lg font-semibold">{book.name}</h3>
                      <p className="text-sm opacity-80">{book.theme}</p>
                    </div>
                  </div>
                  <Badge className={getBookColor(book.color)}>
                    {progress.completed} / {progress.total}
                  </Badge>
                </CardTitle>
              </CardHeader>
              
              <CardContent>
                <div className="space-y-4">
                  <div>
                    <Progress 
                      value={(progress.completed / progress.total) * 100} 
                      className="h-2"
                    />
                    <p className="text-xs text-muted-foreground mt-1">
                      {book.description}
                    </p>
                  </div>
                  
                  {isUnlocked ? (
                    <div className="grid gap-2">
                      {book.chapters.map(chapterNumber => renderChapter(chapterNumber, book.color))}
                    </div>
                  ) : (
                    <div className="text-center py-8 text-muted-foreground">
                      <Lock className="w-8 h-8 mx-auto mb-2" />
                      <p>Complete the previous book to unlock this section</p>
                    </div>
                  )}
                </div>
              </CardContent>
            </Card>
          );
        })}
      </div>
    </div>
  );
}