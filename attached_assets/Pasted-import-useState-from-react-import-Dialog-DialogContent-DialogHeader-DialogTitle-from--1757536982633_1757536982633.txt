import { useState } from "react";
import { Dialog, DialogContent, DialogHeader, DialogTitle } from "@/components/ui/dialog";
import { Button } from "@/components/ui/button";
import { Progress } from "@/components/ui/progress";
import { RadioGroup, RadioGroupItem } from "@/components/ui/radio-group";
import { Label } from "@/components/ui/label";
import { Input } from "@/components/ui/input";
import { useMutation } from "@tanstack/react-query";
import { apiRequest } from "@/lib/queryClient";
import { useToast } from "@/hooks/use-toast";

interface AssessmentModalProps {
  open: boolean;
  onOpenChange: (open: boolean) => void;
}

const generationInfo = {
  'gen-z': {
    name: 'Generation Z',
    description: 'Born 1997-2012: Digital natives, entrepreneurial, value authenticity',
    approach: 'Interactive, visual learning with immediate application'
  },
  'millennial': {
    name: 'Millennials',
    description: 'Born 1981-1996: Purpose-driven, collaborative, tech-savvy',
    approach: 'Community-based learning with meaningful impact focus'
  },
  'gen-x': {
    name: 'Generation X',
    description: 'Born 1965-1980: Independent, practical, work-life balance focused',
    approach: 'Practical application with clear ROI and efficiency'
  },
  'boomer': {
    name: 'Baby Boomers',
    description: 'Born 1946-1964: Experience-rich, relationship-focused, wisdom-oriented',
    approach: 'Traditional study enhanced with modern tools and mentorship'
  },
  'silent': {
    name: 'Silent Generation',
    description: 'Born before 1946: Duty-oriented, traditional values, institutional respect',
    approach: 'Classical approach with deep theological foundation'
  }
};

const assessmentQuestions = [
  {
    id: 1,
    question: "When facing a significant decision, you tend to:",
    options: [
      {
        value: "vision",
        title: "Seek vision and inspiration first",
        description: "You look for the bigger picture and divine guidance",
      },
      {
        value: "analysis",
        title: "Gather all available information",
        description: "You prefer thorough analysis before moving forward",
      },
      {
        value: "relationships",
        title: "Consider impact on relationships",
        description: "You evaluate how it affects your community and team",
      },
    ],
  },
  {
    id: 2,
    question: "Your natural leadership style is:",
    options: [
      {
        value: "pioneering",
        title: "Pioneering new paths",
        description: "You enjoy breaking new ground and exploring possibilities",
      },
      {
        value: "organizing",
        title: "Organizing and coordinating",
        description: "You excel at bringing order and structure to chaos",
      },
      {
        value: "building",
        title: "Building strong foundations",
        description: "You focus on creating stable, lasting systems",
      },
    ],
  },
  {
    id: 3,
    question: "In team settings, you are most energized by:",
    options: [
      {
        value: "innovation",
        title: "Innovation and creativity",
        description: "Generating new ideas and exploring possibilities",
      },
      {
        value: "collaboration",
        title: "Collaboration and harmony",
        description: "Bringing people together and facilitating connection",
      },
      {
        value: "execution",
        title: "Execution and results",
        description: "Getting things done and achieving measurable outcomes",
      },
    ],
  },
];

export default function AssessmentModal({ open, onOpenChange }: AssessmentModalProps) {
  const [step, setStep] = useState<'generation' | 'assessment' | 'results'>('generation');
  const [birthYear, setBirthYear] = useState<string>('');
  const [email, setEmail] = useState<string>('');
  const [generation, setGeneration] = useState<string>('');
  const [currentQuestion, setCurrentQuestion] = useState(0);
  const [responses, setResponses] = useState<Record<number, string>>({});
  const [results, setResults] = useState<any>(null);
  const { toast } = useToast();

  const submitAssessmentMutation = useMutation({
    mutationFn: async (assessmentData: any) => {
      const response = await apiRequest("POST", "/api/assessment/public-submit", assessmentData);
      return response.json();
    },
    onSuccess: (data) => {
      setResults(data);
      setStep('results');
      toast({
        title: "Assessment Complete!",
        description: `You are a ${data.archetype} leader from the ${generationInfo[data.generation as keyof typeof generationInfo]?.name} generation.`,
      });
    },
    onError: (error) => {
      console.error("Error submitting assessment:", error);
      toast({
        title: "Error",
        description: "Failed to submit assessment. Please try again.",
        variant: "destructive",
      });
    },
  });

  const determineGeneration = (year: number): string => {
    if (year >= 1997) return 'gen-z';
    if (year >= 1981) return 'millennial';
    if (year >= 1965) return 'gen-x';
    if (year >= 1946) return 'boomer';
    return 'silent';
  };

  const handleGenerationNext = () => {
    const year = parseInt(birthYear);
    if (year < 1920 || year > 2010) {
      toast({
        title: "Invalid Birth Year",
        description: "Please enter a valid birth year between 1920 and 2010.",
        variant: "destructive",
      });
      return;
    }
    
    const detectedGeneration = determineGeneration(year);
    setGeneration(detectedGeneration);
    setStep('assessment');
  };

  const handleResponse = (value: string) => {
    setResponses(prev => ({
      ...prev,
      [assessmentQuestions[currentQuestion].id]: value,
    }));
  };

  const handleNext = () => {
    if (currentQuestion < assessmentQuestions.length - 1) {
      setCurrentQuestion(prev => prev + 1);
    } else {
      // Submit assessment
      submitAssessmentMutation.mutate({
        responses,
        birthYear: parseInt(birthYear),
        email: email || null,
      });
    }
  };

  const handlePrevious = () => {
    if (currentQuestion > 0) {
      setCurrentQuestion(prev => prev - 1);
    } else {
      setStep('generation');
    }
  };

  const resetAssessment = () => {
    setStep('generation');
    setBirthYear('');
    setEmail('');
    setGeneration('');
    setCurrentQuestion(0);
    setResponses({});
    setResults(null);
  };

  const handleStartJourney = () => {
    onOpenChange(false);
    // Redirect to Chapter 1
    window.location.href = `/matrix?chapter=1&archetype=${results.archetype}&generation=${results.generation}`;
  };

  const renderGenerationStep = () => (
    <div className="space-y-6">
      <div>
        <h3 className="text-lg font-medium mb-4">Let's personalize your leadership journey</h3>
        <p className="text-sm text-muted-foreground mb-6">
          Each generation brings unique strengths to leadership. We'll customize your experience based on your generational perspective.
        </p>
      </div>
      
      <div className="space-y-4">
        <div>
          <Label htmlFor="birthYear">What year were you born?</Label>
          <Input
            id="birthYear"
            type="number"
            placeholder="e.g., 1985"
            value={birthYear}
            onChange={(e) => setBirthYear(e.target.value)}
            min="1920"
            max="2010"
          />
        </div>
        
        <div>
          <Label htmlFor="email">Email (optional - to save your progress)</Label>
          <Input
            id="email"
            type="email"
            placeholder="your@email.com"
            value={email}
            onChange={(e) => setEmail(e.target.value)}
          />
        </div>
      </div>
      
      {birthYear && parseInt(birthYear) >= 1920 && parseInt(birthYear) <= 2010 && (
        <div className="p-4 bg-secondary/30 rounded-lg">
          <h4 className="font-medium text-cosmic-golden">
            {generationInfo[determineGeneration(parseInt(birthYear)) as keyof typeof generationInfo]?.name}
          </h4>
          <p className="text-sm text-muted-foreground mt-1">
            {generationInfo[determineGeneration(parseInt(birthYear)) as keyof typeof generationInfo]?.description}
          </p>
          <p className="text-sm text-cosmic-golden mt-2">
            Learning approach: {generationInfo[determineGeneration(parseInt(birthYear)) as keyof typeof generationInfo]?.approach}
          </p>
        </div>
      )}
    </div>
  );

  const renderAssessmentStep = () => {
    const currentQuestionData = assessmentQuestions[currentQuestion];
    const selectedValue = responses[currentQuestionData.id];
    const progress = ((currentQuestion + 1) / assessmentQuestions.length) * 100;
    
    return (
      <div className="space-y-6">
        <div>
          <div className="flex items-center justify-between mb-4">
            <h3 className="text-lg font-medium">Leadership Archetype Assessment</h3>
            <div className="text-sm text-muted-foreground">
              Question {currentQuestion + 1} of {assessmentQuestions.length}
            </div>
          </div>
          <Progress value={progress} className="h-2" />
        </div>
        
        <div>
          <h4 className="text-base font-medium mb-4">{currentQuestionData.question}</h4>
          
          <RadioGroup value={selectedValue || ""} onValueChange={handleResponse}>
            {currentQuestionData.options.map((option) => (
              <div key={option.value} className="flex items-start space-x-3">
                <RadioGroupItem value={option.value} id={option.value} className="mt-1" />
                <Label 
                  htmlFor={option.value}
                  className="flex-1 p-4 bg-secondary/30 rounded-lg cursor-pointer hover:bg-secondary/50 transition-colors"
                >
                  <div className="font-medium">{option.title}</div>
                  <div className="text-sm text-muted-foreground mt-1">
                    {option.description}
                  </div>
                </Label>
              </div>
            ))}
          </RadioGroup>
        </div>
      </div>
    );
  };

  const renderResultsStep = () => (
    <div className="space-y-6 text-center">
      <div>
        <h3 className="text-xl font-semibold text-cosmic-golden mb-2">
          Your Leadership Profile
        </h3>
        <div className="space-y-4">
          <div className="p-4 bg-cosmic-purple/10 rounded-lg">
            <h4 className="font-medium text-lg">{results.archetype.charAt(0).toUpperCase() + results.archetype.slice(1)} Leader</h4>
            <p className="text-sm text-muted-foreground mt-1">
              {generationInfo[results.generation as keyof typeof generationInfo]?.name} Generation
            </p>
          </div>
          
          <div className="text-left p-4 bg-secondary/20 rounded-lg">
            <p className="text-sm mb-2">
              <strong>Your Journey Starts:</strong> Chapter 1 - Leadership Begins at the Altar
            </p>
            <p className="text-sm text-muted-foreground">
              You'll progress through the YHWH → YESHUA pattern: Yod (Becoming Rooted) → Heh (Becoming Aligned) → Vav (Becoming Clear) → Final Heh (Becoming Embodied) → YESHUA (Fulfillment).
            </p>
          </div>
        </div>
      </div>
      
      <div className="flex gap-3">
        <Button variant="outline" onClick={resetAssessment} className="flex-1">
          Retake Assessment
        </Button>
        <Button onClick={handleStartJourney} className="flex-1">
          Begin Your Journey
        </Button>
      </div>
    </div>
  );

  return (
    <Dialog open={open} onOpenChange={onOpenChange}>
      <DialogContent className="max-w-2xl">
        <DialogHeader>
          <DialogTitle className="text-xl font-semibold">
            {step === 'generation' && "Discover Your Leadership Path"}
            {step === 'assessment' && "Leadership Archetype Assessment"}
            {step === 'results' && "Your Fractal Leadership Profile"}
          </DialogTitle>
        </DialogHeader>
        
        <div className="py-6">
          {step === 'generation' && renderGenerationStep()}
          {step === 'assessment' && renderAssessmentStep()}
          {step === 'results' && renderResultsStep()}
        </div>
        
        {step !== 'results' && (
          <div className="flex items-center justify-between">
            <Button 
              variant="secondary"
              onClick={step === 'generation' ? () => onOpenChange(false) : handlePrevious}
            >
              {step === 'generation' ? 'Cancel' : 'Previous'}
            </Button>
            
            <Button 
              onClick={step === 'generation' ? handleGenerationNext : handleNext}
              disabled={
                (step === 'generation' && (!birthYear || parseInt(birthYear) < 1920 || parseInt(birthYear) > 2010)) ||
                (step === 'assessment' && !responses[assessmentQuestions[currentQuestion].id]) ||
                submitAssessmentMutation.isPending
              }
            >
              {step === 'generation' && 'Continue to Assessment'}
              {step === 'assessment' && currentQuestion === assessmentQuestions.length - 1 
                ? submitAssessmentMutation.isPending 
                  ? "Submitting..." 
                  : "Complete Assessment"
                : "Next Question"
              }
            </Button>
          </div>
        )}
      </DialogContent>
    </Dialog>
  );
}